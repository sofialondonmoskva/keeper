<!DOCTYPE html>
<html>
  <head>
    <title>&gt;productivity keeper&lt;</title>
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootswatch/2.1.1/united/bootstrap.min.css">
    <link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery.ui.all.css" />
    <style>
      .with-percent-background {
        background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAA4oAAACaCAYAAADvs7b+AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoV2luZG93cykiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6NkQyNEM3Q0I2N0EwMTFFMjlGMkE5QzhENUM5Nzg0OUIiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6NkQyNEM3Q0M2N0EwMTFFMjlGMkE5QzhENUM5Nzg0OUIiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo2RDI0QzdDOTY3QTAxMUUyOUYyQTlDOEQ1Qzk3ODQ5QiIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo2RDI0QzdDQTY3QTAxMUUyOUYyQTlDOEQ1Qzk3ODQ5QiIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PuTHCtcAAAMaSURBVHja7NcxEQAgDAAxyoqneq8n9nLI4Egk/PaxM3sAAFesKhUA+N6UAAAAAKMIAACAUQQAAMAoAgAAYBQBAAAwigAAABhFAAAAjCIAAABGEQAAAKMIAACAUQQAAMAoAgAAYBQBAAAwigAAABhFAAAAjCIAAABGEQAAAKMIAACAUQQAAMAoAgAAgFEEAADAKAIAAGAUAQAAMIoAAAAYRQAAAIwiAAAARhEAAACjCAAAgFEEAADAKAIAAGAUAQAAMIoAAAAYRQAAAIwiAAAARhEAAACjCAAAgFEEAADAKAIAAGAUAQAAMIoAAABgFAEAADCKAAAAGEUAAACMIgAAAEYRAAAAowgAAIBRBAAAwCgCAABgFAEAADCKAAAAGEUAAACMIgAAAEYRAAAAowgAAIBRBAAAwCgCAABgFAEAADCKAAAAGEUAAACMIgAAABhFAAAAjCIAAABGEQAAAKMIAACAUQQAAMAoAgAAYBQBAAAwigAAABhFAAAAjCIAAABGEQAAAKMIAACAUQQAAMAoAgAAYBQBAAAwigAAABhFAAAAjCIAAABGEQAAAKMIAAAARhEAAACjCAAAgFEEAADAKAIAAGAUAQAAMIoAAAAYRQAAAIwiAAAARhEAAACjCAAAgFEEAADAKAIAAGAUAQAAMIoAAAAYRQAAAIwiAAAARhEAAACjCAAAgFEEAADAKAIAAIBRBAAAwCgCAABgFAEAADCKAAAAGEUAAACMIgAAAEYRAAAAowgAAIBRBAAAwCgCAABgFAEAADCKAAAAGEUAAACMIgAAAEYRAAAAowgAAIBRBAAAwCgCAABgFAEAADCKAAAAYBQBAAAwigAAABhFAAAAjCIAAABGEQAAAKMIAACAUQQAAMAoAgAAYBQBAAAwigAAABhFAAAAjCIAAABGEQAAAKMIAACAUQQAAMAoAgAAYBQBAAAwigAAABhFAAAAMIoAAAAYRQAAAIwiAAAARhEAAACjCAAAgFEEAADAKAIAAGAUAQAAMIoAAAAYRQAAAIwiAAAARhEAAACjCAAAgFEEAADgTUeAAQCmEgUxIuFi3QAAAABJRU5ErkJggg==);
        background-repeat: repeat-y;
        background-repeat: repeat-y;
        background-size: 200% 100%;
        word-wrap:break-word; 
      }
      .with-percent-background.productive {
        background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAA4oAAACaCAYAAADvs7b+AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoV2luZG93cykiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6RTE4RTA5NDU2NzlGMTFFMkJCNTJDMEY3NjQwNUJFRUUiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6RTE4RTA5NDY2NzlGMTFFMkJCNTJDMEY3NjQwNUJFRUUiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDpFMThFMDk0MzY3OUYxMUUyQkI1MkMwRjc2NDA1QkVFRSIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDpFMThFMDk0NDY3OUYxMUUyQkI1MkMwRjc2NDA1QkVFRSIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PlgK9r4AAAMbSURBVHja7NexEQAQEABBL9WQSO+ib0jOKMPYLeGyi5FrFwDgitmbCgB8r0oAAACAUQQAAMAoAgAAYBQBAAAwigAAABhFAAAAjCIAAABGEQAAAKMIAACAUQQAAMAoAgAAYBQBAAAwigAAABhFAAAAjCIAAABGEQAAAKMIAACAUQQAAMAoAgAAYBQBAADAKAIAAGAUAQAAMIoAAAAYRQAAAIwiAAAARhEAAACjCAAAgFEEAADAKAIAAGAUAQAAMIoAAAAYRQAAAIwiAAAARhEAAACjCAAAgFEEAADAKAIAAGAUAQAAMIoAAAAYRQAAADCKAAAAGEUAAACMIgAAAEYRAAAAowgAAIBRBAAAwCgCAABgFAEAADCKAAAAGEUAAACMIgAAAEYRAAAAowgAAIBRBAAAwCgCAABgFAEAADCKAAAAGEUAAACMIgAAAEYRAAAAjCIAAABGEQAAAKMIAACAUQQAAMAoAgAAYBQBAAAwigAAABhFAAAAjCIAAABGEQAAAKMIAACAUQQAAMAoAgAAYBQBAAAwigAAABhFAAAAjCIAAABGEQAAAKMIAACAUQQAAACjCAAAgFEEAADAKAIAAGAUAQAAMIoAAAAYRQAAAIwiAAAARhEAAACjCAAAgFEEAADAKAIAAGAUAQAAMIoAAAAYRQAAAIwiAAAARhEAAACjCAAAgFEEAADAKAIAAGAUAQAAwCgCAABgFAEAADCKAAAAGEUAAACMIgAAAEYRAAAAowgAAIBRBAAAwCgCAABgFAEAADCKAAAAGEUAAACMIgAAAEYRAAAAowgAAIBRBAAAwCgCAABgFAEAADCKAAAAGEUAAAAwigAAABhFAAAAjCIAAABGEQAAAKMIAACAUQQAAMAoAgAAYBQBAAAwigAAABhFAAAAjCIAAABGEQAAAKMIAACAUQQAAMAoAgAAYBQBAAAwigAAABhFAAAAjCIAAAAYRQAAAIwiAAAARhEAAACjCAAAgFEEAADAKAIAAGAUAQAAMIoAAAAYRQAAAIwiAAAARhEAAACjCAAAgFEEAADAKAIAAPCmI8AAciYFMTbxjE8AAAAASUVORK5CYII=);
      }
    </style>

    <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
    <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.0/jquery-ui.min.js"></script>

    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script type="text/javascript">
      google.load('visualization', '1.0', {'packages':['corechart']});
      google.setOnLoadCallback(drawChart);
      function drawChart() {
        data = new google.visualization.DataTable();
        data.addColumn('string', 'App');
        data.addColumn('number', 'Duration');
        data.addRows(<%= @applications.map { |x| ["#{x.name} - #{humanize(x.duration)}",x.duration.to_i]}.to_json%>);

        container = $('#chart_pie')
        chart = new google.visualization.PieChart(container.get(0));
        chart.draw(data, {'width':container.width(),'height':280,'chartArea': {'width': '80%', 'height': '80%'}});

        productivity = new google.visualization.DataTable();
        productivity.addColumn('datetime', 'Date');
        productivity.addColumn('number', 'Productivity');
        productivity.addRows(<%= @stamps.map { |k,v| ["new Date(#{k} * 1000 )",v.to_i]}.to_json.dequote%>);
        container = $('#chart_line')
        chart = new google.visualization.ColumnChart(container.get(0));
        chart.draw(productivity,  {
                                    width:container.width(),
                                    height:400,
                                    legend: 'none',
                                    chartArea: {'width': '80%', 'height': '80%'}
                                  });

        productivity = new google.visualization.DataTable();

        productivity.addColumn('number', 'Productivity');
        productivity.addColumn('number', 'Hour');
        productivity.addColumn('number', 'Hour');
        offset = (new Date().getTimezoneOffset()) / 60 // i just love it when some things are in mili seconds, some in seconds and some in minutes
        productivity.addRows(<%= @hours.sort.map { |k,v| ["#{k} - offset",v < 0 ? nil : v,v < 0 ? v : nil] }.to_json.dequote%>);

        container = $('#chart_hour')
        chart = new google.visualization.ColumnChart(container.get(0));
        chart.draw(productivity,  {
                                    title: 'productivity per hour',
                                    width:container.width(),
                                    height:500,
                                    legend: 'none',
                                    chartArea: {'width': '80%', 'height': '80%'},
                                    hAxis: { title: 'Hour',gridlines: {count: 12},format: '#'},
                                  });
      }

      $(function() {
        $("#_from" ).datepicker({
          altField: '#from',
          altFormat: '@',
          defaultDate: "-1w",
          changeMonth: true,
          numberOfMonths: 2,
          onClose: function( selectedDate ) {
            $( "#_to" ).datepicker( "option", "minDate", selectedDate );
          }
        });
        $("#_to" ).datepicker({
          altField: '#to',
          altFormat: '@',
          defaultDate: "-1w",
          changeMonth: true,
          numberOfMonths: 2,
          onClose: function( selectedDate ) {
            $( "#_from" ).datepicker( "option", "maxDate", selectedDate );
          }
        });
        $('#_to').datepicker("setDate" , new Date(<%= @to * 1000 %>))
        $('#_from').datepicker("setDate" ,new Date(<%= @from * 1000 %>))
      });
    </script>
  </head>
  <body>
    <div class="container-fluid">
      <div class="row">
        <div class="navbar">
          <div class="navbar-inner">
            <div class="container-fluid">
              <% 
                activity_stamps = @stamps.keys

                activity_start = Time.at(activity_stamps.first.to_i)
                activity_end = Time.at(activity_stamps.last.to_i)
                activity_days = ((activity_end - activity_start) / 1.day).to_f
                sitting = ((@activity / 1.day) / activity_days ) * 100
              %>
              <a class="brand" href="?" style="font-size:14px"><%=@productivity.round%>% for <%=humanize(@activity)%> activity, <%=sitting.round%>% of your life between <%= activity_start.strftime "%Y/%-m/%-d"%> and <%= activity_end.strftime "%Y/%-m/%-d" %> (<%=activity_days.round%>d)</a>
              <ul class="nav pull-right">
                <% now = Time.now.utc %>
                <li><a href="?from=<%=now.beginning_of_day.to_i.ms%>&to=<%=now.end_of_day.to_i.ms%>">today</a>
                <li><a href="?from=<%=(now.beginning_of_day.to_i - 1.day).ms%>&to=<%=now.beginning_of_day.to_i.ms%>">yesterday</a></li>
                <li><a href="?from=1&to=<%=now.end_of_day.to_i.ms%>">forever</a></li>
                <li class="divider-vertical"></li>
                <li>
                  <form class="navbar-form pull-right">
                  <input class="input input-small" type="text" id="_from" name="_from" />
                  <input class="btn" type=submit name="filter" value=" filter "> 
                  <input class="input input-small" type="text" id="_to" name="_to" />
                  
                  <input type="hidden" id="to" name="to" />
                  <input type="hidden" id="from" name="from"/>
                  </form>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      <div class="row-fluid">
        <div class="span7">       
          <div id="chart_pie"></div>
          <div id="chart_line"></div>
          <div id="chart_hour"></div>
        </div>
        <div class="span5">
          <table class="table table-striped">
            <% max = @applications.map { |x| x.duration}.max %>
            <% @applications.each do |a| %>
              <% percent = 100 - ((a.duration / max.to_f) * 100) %>
              <tr>
                <td class="with-percent-background <%= a.productive? ? "productive" : ""%>" style="background-position: <%=percent%>% top;">
                  <%=a.name%> <span class="label label-info"><%= humanize(a.duration)%></span>
                </td>
                <td>
                <a href="?application=<%=a.id%>&down=true&<%=keep_time%>"><i class="icon icon-arrow-down"></i></a>
                  <span class="badge badge-<%=a.productive? ? 'success' : 'inverse'%>"><%=a.productivity >= 0 ? "&nbsp;#{a.productivity}" : "#{a.productivity}"%></span>
                  <a href="?application=<%=a.id%>&up=true&<%=keep_time%>"><i class="icon icon-arrow-up"></i></a>
                  <a href="javascript: if(confirm('Are you sure you want to delete \'<%=a.name%>\'?')) location.href='?application=<%=a.id%>&delete=true';"><i class="icon icon-remove"></i></a>
                </td>
              </tr>
            <% end %>
            <% if @ignored.count > 0 %>
              <tr>
                <td colspan=2><small>ignored: <%= @ignored.map { |x| "<a href='?application=#{x.id}&up=true&#{keep_time}'>#{x.name}</a>"}.join(", ")%></small></td>
              </tr>
            <% end %>
          </table>
        </div>
      </div>
    </div>
  </body>
</html>
